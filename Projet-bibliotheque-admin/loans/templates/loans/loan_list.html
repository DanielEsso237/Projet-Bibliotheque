{% extends 'books/base.html' %}
{% load static %}

{% block title %}Liste des emprunts{% endblock %}

{% block extra_css %}
    <style>
        body.dark-mode .form-control,
        body.dark-mode .form-select {
            background-color: #2c3034;
            color: #f8f9fa;
            border-color: #495057;
        }
        body.dark-mode .form-control:focus,
        body.dark-mode .form-select:focus {
            background-color: #343a40;
            color: #f8f9fa;
            border-color: #6c757d;
            box-shadow: 0 0 0 0.2rem rgba(108, 117, 125, 0.25);
        }
        body.dark-mode ::placeholder {
            color: #adb5bd;
        }
        body.dark-mode .alert-info {
            background-color: #343a40;
            color: #f8f9fa;
            border-color: #495057;
        }
        body.dark-mode .alert-info a {
            color: #66b0ff;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="container-fluid">
        <h1 class="h3 mb-4">ðŸ“š Gestion des retours</h1>

        <!-- Barre de recherche et filtre -->
        <div class="row mb-4">
            <div class="col-md-6">
                <input type="text" id="searchInput" class="form-control" placeholder="Rechercher par titre ou utilisateur..." value="{{ request.GET.search|default:'' }}">
            </div>
            <div class="col-md-6">
                <form id="filterForm">
                    <select name="status" id="statusFilter" class="form-select w-auto">
                        <option value="">Tous les statuts</option>
                        <option value="in_progress" {% if request.GET.status == 'in_progress' %}selected{% endif %}>En cours</option>
                        <option value="overdue" {% if request.GET.status == 'overdue' %}selected{% endif %}>En retard</option>
                    </select>
                </form>
            </div>
        </div>

        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} text-center" role="alert">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        <!-- Liste des emprunts -->
        <div id="loansList">
            {% if loans %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="loansTable">
                        <thead>
                            <tr>
                                <th>Livre</th>
                                <th>Utilisateur</th>
                                <th>Date d'emprunt</th>
                                <th>Date limite</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="loansContainer">
                            {% for loan in loans %}
                                <tr>
                                    <td>{{ loan.book.title }}</td>
                                    <td>{{ loan.user.username }}</td>
                                    <td>{{ loan.loan_date|date:"d/m/Y H:i" }}</td>
                                    <td>{{ loan.due_date|date:"d/m/Y H:i" }}</td>
                                    <td>
                                        {% if loan.due_date < now %}
                                            <span class="badge bg-danger">En retard</span>
                                        {% else %}
                                            <span class="badge bg-success">En cours</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{% url 'loans:return_book' loan.id %}" class="btn btn-sm btn-success">
                                            <i class="fas fa-undo"></i> Marquer comme rendu
                                        </a>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            {% else %}
                <div class="alert alert-info" id="noResultsMessage">Aucun emprunt actif pour le moment.</div>
            {% endif %}
        </div>

        <!-- Pagination -->
        <div id="paginationContainer">
            {% if loans.paginator.num_pages > 1 %}
                <nav aria-label="Page navigation" class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% if loans.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page=1&search={{ request.GET.search|default:'' }}&status={{ request.GET.status|default:'' }}">Â« PremiÃ¨re</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ loans.previous_page_number }}&search={{ request.GET.search|default:'' }}&status={{ request.GET.status|default:'' }}">PrÃ©cÃ©dent</a>
                            </li>
                        {% endif %}
                        {% for num in loans.paginator.page_range %}
                            <li class="page-item {% if loans.number == num %}active{% endif %}">
                                <a class="page-link" href="?page={{ num }}&search={{ request.GET.search|default:'' }}&status={{ request.GET.status|default:'' }}">{{ num }}</a>
                            </li>
                        {% endfor %}
                        {% if loans.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ loans.next_page_number }}&search={{ request.GET.search|default:'' }}&status={{ request.GET.status|default:'' }}">Suivant</a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ loans.paginator.num_pages }}&search={{ request.GET.search|default:'' }}&status={{ request.GET.status|default:'' }}">DerniÃ¨re Â»</a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        // Passer l'URL de return_book Ã  JavaScript
        const returnBookUrlBase = "{% url 'loans:return_book' 0 %}".replace('/0/', '/');

        document.addEventListener('DOMContentLoaded', function () {
            const searchInput = document.getElementById('searchInput');
            const statusFilter = document.getElementById('statusFilter');
            const loansList = document.getElementById('loansList');
            const paginationContainer = document.getElementById('paginationContainer');

            let loansContainer = document.getElementById('loansContainer');

            // CrÃ©er l'Ã©lÃ©ment noResultsMessage s'il n'existe pas
            let noResultsMessage = document.getElementById('noResultsMessage');
            if (!noResultsMessage) {
                noResultsMessage = document.createElement('div');
                noResultsMessage.className = 'alert alert-info';
                noResultsMessage.id = 'noResultsMessage';
                noResultsMessage.textContent = 'Aucun emprunt trouvÃ©.';
            }

            function fetchLoans() {
                const search = encodeURIComponent(searchInput.value.trim());
                const status = statusFilter.value;
                const page = new URLSearchParams(window.location.search).get('page') || '1';

                fetch(`/loans/api/search/?search=${search}&status=${status}&page=${page}`, {
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Erreur rÃ©seau ou autorisation');
                    }
                    return response.json();
                })
                .then(data => {
                    // Si la table n'existe pas, la crÃ©er
                    if (!document.getElementById('loansTable')) {
                        const tableWrapper = document.createElement('div');
                        tableWrapper.className = 'table-responsive';
                        tableWrapper.innerHTML = `
                            <table class="table table-striped table-hover" id="loansTable">
                                <thead>
                                    <tr>
                                        <th>Livre</th>
                                        <th>Utilisateur</th>
                                        <th>Date d'emprunt</th>
                                        <th>Date limite</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="loansContainer"></tbody>
                            </table>`;
                        loansList.innerHTML = '';
                        loansList.appendChild(tableWrapper);
                        loansContainer = document.getElementById('loansContainer');
                    }

                    // Vider uniquement le contenu de loansContainer
                    loansContainer.innerHTML = '';

                    if (data.loans.length === 0) {
                        loansList.innerHTML = '';
                        loansList.appendChild(noResultsMessage);
                    } else {
                        // Remplir loansContainer avec les nouvelles lignes
                        data.loans.forEach(loan => {
                            const loanRow = document.createElement('tr');
                            loanRow.innerHTML = `
                                <td>${loan.book_title}</td>
                                <td>${loan.user_username}</td>
                                <td>${loan.loan_date}</td>
                                <td>${loan.due_date}</td>
                                <td>
                                    ${loan.is_overdue ? 
                                        `<span class="badge bg-danger">En retard</span>` : 
                                        `<span class="badge bg-success">En cours</span>`}
                                </td>
                                <td>
                                    <a href="${returnBookUrlBase}${loan.id}/" class="btn btn-sm btn-success">
                                        <i class="fas fa-undo"></i> Marquer comme rendu
                                    </a>
                                </td>`;
                            loansContainer.appendChild(loanRow);
                        });
                    }

                    // Mettre Ã  jour la pagination
                    paginationContainer.innerHTML = '';
                    if (data.paginator.num_pages > 1) {
                        const nav = document.createElement('nav');
                        nav.setAttribute('aria-label', 'Page navigation');
                        nav.className = 'mt-4';
                        const ul = document.createElement('ul');
                        ul.className = 'pagination justify-content-center';

                        if (data.has_previous) {
                            ul.innerHTML += `
                                <li class="page-item">
                                    <a class="page-link" href="?page=1&search=${search}&status=${status}">Â« PremiÃ¨re</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page=${data.previous_page_number}&search=${search}&status=${status}">PrÃ©cÃ©dent</a>
                                </li>`;
                        }

                        data.page_range.forEach(num => {
                            ul.innerHTML += `
                                <li class="page-item ${num === data.current_page ? 'active' : ''}">
                                    <a class="page-link" href="?page=${num}&search=${search}&status=${status}">${num}</a>
                                </li>`;
                        });

                        if (data.has_next) {
                            ul.innerHTML += `
                                <li class="page-item">
                                    <a class="page-link" href="?page=${data.next_page_number}&search=${search}&status=${status}">Suivant</a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page=${data.paginator.num_pages}&search=${search}&status=${status}">DerniÃ¨re Â»</a>
                                </li>`;
                        }

                        nav.appendChild(ul);
                        paginationContainer.appendChild(nav);
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    loansList.innerHTML = '<div class="alert alert-danger">Une erreur est survenue. Veuillez rÃ©essayer.</div>';
                });
            }

            // Ã‰couteurs pour la recherche et le filtrage
            searchInput.addEventListener('input', () => {
                const debounce = setTimeout(fetchLoans, 300);
                return () => clearTimeout(debounce);
            });
            statusFilter.addEventListener('change', fetchLoans);

            // Gestion des clics sur la pagination
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('page-link')) {
                    e.preventDefault();
                    const url = new URL(e.target.href);
                    const params = new URLSearchParams(url.search);
                    const page = params.get('page') || '1';
                    window.history.pushState({}, '', `?page=${page}&search=${encodeURIComponent(searchInput.value.trim())}&status=${statusFilter.value}`);
                    fetchLoans();
                }
            });

            // Initial load
            fetchLoans();
        });
    </script>
{% endblock %}
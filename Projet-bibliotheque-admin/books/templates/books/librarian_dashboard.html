{% extends 'books/base.html' %}
{% load static %}

{% block title %}Tableau de bord - Bibliothécaire{% endblock %}

{% block extra_css %}
    <style>
        .stats-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .table-container {
            background-color: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 8px;
            padding: 1rem;
        }
        .view-toggle-btn {
            transition: background-color 0.3s ease;
        }
        .modal-content {
            border-radius: 10px;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
{% endblock %}

{% block content %}
    <div class="container-fluid">
        <!-- En-tête -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3"><i class="fas fa-tachometer-alt me-2"></i> Tableau de bord</h1>
            <div>
                <a href="{% url 'books:add_book' %}" class="btn btn-primary me-2">
                    <i class="fas fa-plus-circle me-1"></i> Ajouter un livre
                </a>
                <a href="{% url 'books:choose_document_type' %}" class="btn btn-success">
                    <i class="fas fa-file-alt me-1"></i> Ajouter un document
                </a>
            </div>
        </div>

        <!-- Statistiques -->
        <div class="row mb-4">
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card stats-card bg-primary text-white">
                    <div class="card-body d-flex align-items-center">
                        <i class="fas fa-books fa-2x me-3"></i>
                        <div>
                            <h5 class="card-title mb-0">Total Livres</h5>
                            <p class="card-text fs-4" id="totalBooks">0</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card stats-card bg-success text-white">
                    <div class="card-body d-flex align-items-center">
                        <i class="fas fa-check-circle fa-2x me-3"></i>
                        <div>
                            <h5 class="card-title mb-0">Disponibles</h5>
                            <p class="card-text fs-4" id="availableBooks">0</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card stats-card bg-warning text-dark">
                    <div class="card-body d-flex align-items-center">
                        <i class="fas fa-book-open fa-2x me-3"></i>
                        <div>
                            <h5 class="card-title mb-0">E-books</h5>
                            <p class="card-text fs-4" id="ebooks">0</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 col-sm-6 mb-3">
                <div class="card stats-card bg-info text-white">
                    <div class="card-body d-flex align-items-center">
                        <i class="fas fa-box-open fa-2x me-3"></i>
                        <div>
                            <h5 class="card-title mb-0">Physiques</h5>
                            <p class="card-text fs-4" id="physicalBooks">0</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filtres et Recherche -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4">
                        <input type="text" id="searchInput" class="form-control" placeholder="Rechercher par titre ou auteur..." value="{{ request.GET.search|default:'' }}">
                    </div>
                    <div class="col-md-3">
                        <select id="availabilityFilter" class="form-select">
                            <option value="">Tous les statuts</option>
                            <option value="true" {% if request.GET.availability == 'true' %}selected{% endif %}>Disponible</option>
                            <option value="false" {% if request.GET.availability == 'false' %}selected{% endif %}>Indisponible</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select id="typeFilter" class="form-select">
                            <option value="">Tous les types</option>
                            <option value="physical">Physique</option>
                            <option value="ebook">E-book</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-center">
                        <button class="btn btn-outline-primary view-toggle-btn" id="viewToggleBtn" title="Basculer vue">
                            <i class="fas fa-table"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Liste des livres -->
        <div class="table-container fade-in">
            <div id="booksList">
                <table class="table table-hover" id="booksTable" style="display: none;">
                    <thead>
                        <tr>
                            <th scope="col" class="sortable" data-sort="title">Titre <i class="fas fa-sort"></i></th>
                            <th scope="col" class="sortable" data-sort="author">Auteur <i class="fas fa-sort"></i></th>
                            <th scope="col">Type</th>
                            <th scope="col">Quantité</th>
                            <th scope="col">Disponibilité</th>
                            <th scope="col">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="booksTableBody"></tbody>
                </table>
                <div class="row row-cols-1 row-cols-md-3 g-4" id="booksCards"></div>
            </div>
            <div id="noResultsMessage" class="alert alert-info" style="display: none;">Aucun livre trouvé.</div>
            <nav aria-label="Page navigation" class="mt-4">
                <ul class="pagination justify-content-center" id="paginationContainer"></ul>
            </nav>
        </div>

        <!-- Modales -->
        <div class="modal fade" id="deleteBookModal" tabindex="-1" aria-labelledby="deleteBookModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deleteBookModalLabel">Confirmer la suppression</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        Êtes-vous sûr de vouloir supprimer "<span id="bookTitle"></span>" ? Cette action est irréversible.
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                        <form id="deleteBookForm" method="post" action="">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger">Supprimer</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="viewDetailsModal" tabindex="-1" aria-labelledby="viewDetailsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="viewDetailsModalLabel">Détails du livre</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="text-center mb-3">
                            <img id="detailCover" src="" alt="Couverture" class="img-fluid rounded" style="max-height: 150px; display: none;">
                            <span id="detailCoverText" class="text-muted"></span>
                        </div>
                        <p><strong>Titre :</strong> <span id="detailTitle"></span></p>
                        <p><strong>Auteur :</strong> <span id="detailAuthor"></span></p>
                        <p><strong>Type :</strong> <span id="detailType"></span></p>
                        <p><strong>Quantité :</strong> <span id="detailQuantity"></span></p>
                        <p><strong>Disponibilité :</strong> <span id="detailAvailability"></span></p>
                        <p id="ebookFileContainer" style="display: none;"><strong>PDF :</strong> <a id="detailEbookFile" href="#" target="_blank">Voir</a></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="editBookModal" tabindex="-1" aria-labelledby="editBookModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="editBookModalLabel">Modifier le livre</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editBookForm" method="post" enctype="multipart/form-data">
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="editTitle" class="form-label">Titre</label>
                                <input type="text" class="form-control" id="editTitle" name="title" required>
                            </div>
                            <div class="mb-3">
                                <label for="editAuthor" class="form-label">Auteur</label>
                                <input type="text" class="form-control" id="editAuthor" name="author" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Type</label>
                                <div class="form-check form-check-inline">
                                    <input type="radio" class="form-check-input type-radio" id="editIsPhysicalYes" name="is_physical" value="True" data-toggle="physical">
                                    <label class="form-check-label" for="editIsPhysicalYes">Physique</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input type="radio" class="form-check-input type-radio" id="editIsPhysicalNo" name="is_physical" value="False" data-toggle="ebook">
                                    <label class="form-check-label" for="editIsPhysicalNo">E-book</label>
                                </div>
                            </div>
                            <div class="mb-3" id="quantityField">
                                <label for="editQuantity" class="form-label">Quantité</label>
                                <input type="number" class="form-control" id="editQuantity" name="quantity" min="1">
                            </div>
                            <div class="mb-3" id="ebookFileField" style="display: none;">
                                <label for="editEbookFile" class="form-label">Fichier PDF</label>
                                <input type="file" class="form-control" id="editEbookFile" name="ebook_file" accept=".pdf">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Disponibilité</label>
                                <div class="form-check form-check-inline">
                                    <input type="radio" class="form-check-input" id="editIsAvailableYes" name="is_available" value="True">
                                    <label class="form-check-label" for="editIsAvailableYes">Disponible</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input type="radio" class="form-check-input" id="editIsAvailableNo" name="is_available" value="False">
                                    <label class="form-check-label" for="editIsAvailableNo">Indisponible</label>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="editCoverImage" class="form-label">Couverture</label>
                                <input type="file" class="form-control" id="editCoverImage" name="cover_image">
                            </div>
                            <button type="submit" class="btn btn-primary">Enregistrer</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const searchInput = document.getElementById('searchInput');
            const availabilityFilter = document.getElementById('availabilityFilter');
            const typeFilter = document.getElementById('typeFilter');
            const booksTable = document.getElementById('booksTable');
            const booksTableBody = document.getElementById('booksTableBody');
            const booksCards = document.getElementById('booksCards');
            const noResultsMessage = document.getElementById('noResultsMessage');
            const paginationContainer = document.getElementById('paginationContainer');
            const viewToggleBtn = document.getElementById('viewToggleBtn');
            let isTableView = false;
            let sortField = 'title';
            let sortOrder = 'asc';

            // Charger les stats
            function fetchStats() {
                fetch('/books/api/stats/', {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(response => response.json())
                .then(data => {
                    document.getElementById('totalBooks').textContent = data.total_books || 0;
                    document.getElementById('availableBooks').textContent = data.available_books || 0;
                    document.getElementById('ebooks').textContent = data.ebooks || 0;
                    document.getElementById('physicalBooks').textContent = data.physical_books || 0;
                })
                .catch(error => console.error('Erreur stats:', error));
            }

            // Charger les livres
            function fetchBooks() {
                const search = searchInput.value;
                const availability = availabilityFilter.value;
                const type = typeFilter.value;
                const page = new URLSearchParams(window.location.search).get('page') || '1';

                fetch(`/books/api/search/?search=${encodeURIComponent(search)}&availability=${availability}&type=${type}&page=${page}&sort=${sortField}&order=${sortOrder}`, {
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                })
                .then(response => response.json())
                .then(data => {
                    // Mettre à jour la liste
                    booksTableBody.innerHTML = '';
                    booksCards.innerHTML = '';
                    if (data.books.length === 0) {
                        noResultsMessage.style.display = 'block';
                        booksTable.style.display = 'none';
                        booksCards.style.display = 'none';
                    } else {
                        noResultsMessage.style.display = 'none';
                        if (isTableView) {
                            booksTable.style.display = 'table';
                            booksCards.style.display = 'none';
                            data.books.forEach(book => {
                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${book.title}</td>
                                    <td>${book.author}</td>
                                    <td>${book.is_physical ? 'Physique' : 'E-book'}</td>
                                    <td>${book.quantity || '-'}</td>
                                    <td><span class="badge bg-${book.is_available ? 'success' : 'danger'}">${book.is_available ? 'Disponible' : 'Indisponible'}</span></td>
                                    <td>
                                        <a href="#" class="btn btn-sm btn-primary edit-book-btn" data-bs-toggle="modal" data-bs-target="#editBookModal" data-book-id="${book.id}"><i class="fas fa-edit"></i></a>
                                        <a href="#" class="btn btn-sm btn-danger delete-book-btn" data-bs-toggle="modal" data-bs-target="#deleteBookModal" data-book-id="${book.id}" data-book-title="${book.title}"><i class="fas fa-trash"></i></a>
                                        <a href="#" class="btn btn-sm btn-info view-details-btn" data-bs-toggle="modal" data-bs-target="#viewDetailsModal" data-book-id="${book.id}"><i class="fas fa-info-circle"></i></a>
                                    </td>`;
                                booksTableBody.appendChild(row);
                            });
                        } else {
                            booksTable.style.display = 'none';
                            booksCards.style.display = 'grid';
                            data.books.forEach(book => {
                                const card = document.createElement('div');
                                card.className = 'col';
                                card.innerHTML = `
                                    <div class="card book-card h-100 shadow-sm">
                                        <div class="card-img-wrapper">
                                            ${book.cover_image ? `<img src="${book.cover_image}" class="card-img-top" alt="${book.title}">` : `<div class="card-img-placeholder"><span>📖</span></div>`}
                                        </div>
                                        <div class="card-body d-flex flex-column">
                                            <h5 class="card-title text-truncate" title="${book.title}">${book.title}</h5>
                                            <p class="card-text text-muted text-truncate" title="${book.author}">${book.author}</p>
                                            <p class="card-text">${book.is_physical ? `Physique (Quantité: ${book.quantity})` : 'E-book'}</p>
                                            <p class="card-text"><span class="badge bg-${book.is_available ? 'success' : 'danger'}">${book.is_available ? 'Disponible' : 'Indisponible'}</span></p>
                                            <div class="mt-auto d-flex gap-1">
                                                <a href="#" class="btn btn-sm btn-primary edit-book-btn" data-bs-toggle="modal" data-bs-target="#editBookModal" data-book-id="${book.id}"><i class="fas fa-edit"></i></a>
                                                <a href="#" class="btn btn-sm btn-danger delete-book-btn" data-bs-toggle="modal" data-bs-target="#deleteBookModal" data-book-id="${book.id}" data-book-title="${book.title}"><i class="fas fa-trash"></i></a>
                                                <a href="#" class="btn btn-sm btn-info view-details-btn" data-bs-toggle="modal" data-bs-target="#viewDetailsModal" data-book-id="${book.id}"><i class="fas fa-info-circle"></i></a>
                                            </div>
                                        </div>
                                    </div>`;
                                booksCards.appendChild(card);
                            });
                        }
                    }

                    // Mettre à jour la pagination
                    paginationContainer.innerHTML = '';
                    if (data.paginator.num_pages > 1) {
                        const ul = document.createElement('ul');
                        ul.className = 'pagination justify-content-center';
                        if (data.has_previous) {
                            ul.innerHTML += `
                                <li class="page-item"><a class="page-link" href="?page=1&search=${encodeURIComponent(search)}&availability=${availability}&type=${type}">«</a></li>
                                <li class="page-item"><a class="page-link" href="?page=${data.previous_page_number}&search=${encodeURIComponent(search)}&availability=${availability}&type=${type}">Précédent</a></li>`;
                        }
                        data.page_range.forEach(num => {
                            ul.innerHTML += `
                                <li class="page-item ${num === data.current_page ? 'active' : ''}">
                                    <a class="page-link" href="?page=${num}&search=${encodeURIComponent(search)}&availability=${availability}&type=${type}">${num}</a>
                                </li>`;
                        });
                        if (data.has_next) {
                            ul.innerHTML += `
                                <li class="page-item"><a class="page-link" href="?page=${data.next_page_number}&search=${encodeURIComponent(search)}&availability=${availability}&type=${type}">Suivant</a></li>
                                <li class="page-item"><a class="page-link" href="?page=${data.paginator.num_pages}&search=${encodeURIComponent(search)}&availability=${availability}&type=${type}">»</a></li>`;
                        }
                        paginationContainer.appendChild(ul);
                    }
                })
                .catch(error => console.error('Erreur livres:', error));
            }

            // Toggle vue table/cartes
            viewToggleBtn.addEventListener('click', () => {
                isTableView = !isTableView;
                viewToggleBtn.innerHTML = `<i class="fas fa-${isTableView ? 'th' : 'table'}"></i>`;
                fetchBooks();
            });

            // Tri des colonnes
            document.querySelectorAll('.sortable').forEach(th => {
                th.addEventListener('click', () => {
                    const field = th.dataset.sort;
                    if (sortField === field) {
                        sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortField = field;
                        sortOrder = 'asc';
                    }
                    th.querySelector('i').className = `fas fa-sort${sortOrder === 'asc' ? '-up' : '-down'}`;
                    document.querySelectorAll('.sortable').forEach(otherTh => {
                        if (otherTh !== th) otherTh.querySelector('i').className = 'fas fa-sort';
                    });
                    fetchBooks();
                });
            });

            // Écouteurs pour filtres
            searchInput.addEventListener('input', fetchBooks);
            availabilityFilter.addEventListener('change', fetchBooks);
            typeFilter.addEventListener('change', fetchBooks);

            // Pagination
            paginationContainer.addEventListener('click', e => {
                if (e.target.classList.contains('page-link')) {
                    e.preventDefault();
                    const url = new URL(e.target.href);
                    const params = new URLSearchParams(url.search);
                    window.history.pushState({}, '', `?${params.toString()}`);
                    fetchBooks();
                }
            });

            // Suppression
            document.addEventListener('click', e => {
                if (e.target.closest('.delete-book-btn')) {
                    const btn = e.target.closest('.delete-book-btn');
                    const bookId = btn.dataset.bookId;
                    const bookTitle = btn.dataset.bookTitle;
                    document.getElementById('bookTitle').textContent = bookTitle;
                    document.getElementById('deleteBookForm').action = `/books/delete/${bookId}/`;
                }
            });

            // Détails
            document.addEventListener('click', e => {
                if (e.target.closest('.view-details-btn')) {
                    const btn = e.target.closest('.view-details-btn');
                    const bookId = btn.dataset.bookId;
                    fetch(`/books/api/book/${bookId}/`)
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById('detailTitle').textContent = data.title || 'N/A';
                            document.getElementById('detailAuthor').textContent = data.author || 'N/A';
                            document.getElementById('detailType').textContent = data.is_physical ? 'Physique' : 'E-book';
                            document.getElementById('detailQuantity').textContent = data.quantity || 'N/A';
                            document.getElementById('detailAvailability').textContent = data.is_available ? 'Disponible' : 'Indisponible';
                            const cover = document.getElementById('detailCover');
                            const coverText = document.getElementById('detailCoverText');
                            if (data.cover_image) {
                                cover.src = data.cover_image;
                                cover.style.display = 'inline-block';
                                coverText.textContent = '';
                            } else {
                                cover.style.display = 'none';
                                coverText.textContent = 'Aucune couverture';
                            }
                            const ebookContainer = document.getElementById('ebookFileContainer');
                            const ebookLink = document.getElementById('detailEbookFile');
                            if (data.ebook_file && !data.is_physical) {
                                ebookLink.href = data.ebook_file;
                                ebookContainer.style.display = 'block';
                            } else {
                                ebookContainer.style.display = 'none';
                            }
                        });
                }
            });

            // Modification
            document.addEventListener('click', e => {
                if (e.target.closest('.edit-book-btn')) {
                    const btn = e.target.closest('.edit-book-btn');
                    const bookId = btn.dataset.bookId;
                    fetch(`/books/api/book/${bookId}/`)
                        .then(response => response.json())
                        .then(data => {
                            const form = document.getElementById('editBookForm');
                            form.action = `/books/edit/${bookId}/`;
                            document.getElementById('editTitle').value = data.title || '';
                            document.getElementById('editAuthor').value = data.author || '';
                            document.getElementById('editIsPhysicalYes').checked = data.is_physical;
                            document.getElementById('editIsPhysicalNo').checked = !data.is_physical;
                            document.getElementById('editIsAvailableYes').checked = data.is_available;
                            document.getElementById('editIsAvailableNo').checked = !data.is_available;
                            document.getElementById('editQuantity').value = data.quantity || 1;
                            const quantityField = document.getElementById('quantityField');
                            const ebookField = document.getElementById('ebookFileField');
                            if (data.is_physical) {
                                quantityField.style.display = 'block';
                                ebookField.style.display = 'none';
                                document.getElementById('editQuantity').required = true;
                                document.getElementById('editEbookFile').required = false;
                            } else {
                                quantityField.style.display = 'none';
                                ebookField.style.display = 'block';
                                document.getElementById('editQuantity').required = false;
                                document.getElementById('editEbookFile').required = false;
                            }
                        });
                }
            });

            // Gestion du type (physique/e-book)
            document.querySelectorAll('.type-radio').forEach(radio => {
                radio.addEventListener('change', () => {
                    const quantityField = document.getElementById('quantityField');
                    const ebookField = document.getElementById('ebookFileField');
                    if (radio.value === 'True') {
                        quantityField.style.display = 'block';
                        ebookField.style.display = 'none';
                        document.getElementById('editQuantity').required = true;
                        document.getElementById('editEbookFile').required = false;
                    } else {
                        quantityField.style.display = 'none';
                        ebookField.style.display = 'block';
                        document.getElementById('editQuantity').required = false;
                        document.getElementById('editEbookFile').required = false;
                    }
                });
            });

            // Initialisation
            fetchStats();
            fetchBooks();
        });
    </script>
{% endblock %}
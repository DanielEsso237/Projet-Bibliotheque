{% extends 'books/base.html' %}
{% load static %}

{% block title %}Notifications{% endblock %}

{% block extra_css %}
    <style>
        body.dark-mode .form-select {
            background-color: #2c3034;
            color: #f8f9fa;
            border-color: #495057;
        }
        body.dark-mode .form-select:focus {
            background-color: #343a40;
            color: #f8f9fa;
            border-color: #6c757d;
            box-shadow: 0 0 0 0.2rem rgba(108, 117, 125, 0.25);
        }
        body.dark-mode #no-notifications {
            background-color: #343a40;
            color: #f8f9fa;
            border-color: #495057;
        }
        body.dark-mode #no-notifications a {
            color: #66b0ff;
        }
    </style>
{% endblock %}

{% block content %}
    <!-- Conteneur pour les toasts -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1050;">
        <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <strong class="me-auto">Notification</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body"></div>
        </div>
    </div>

    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h3>Notifications</h3>
            <div>
                <select id="typeFilter" class="form-select w-auto d-inline-block me-2" onchange="filterNotifications()">
                    <option value="all">Tous les types</option>
                    <option value="warning-return">Retours proches</option>
                    <option value="warning-stock">Stocks faibles</option>
                    <option value="danger-overdue">Retards</option>
                    <option value="danger-stock">Stocks critiques</option>
                </select>
                <button class="btn btn-primary d-inline-block me-2" onclick="markAllAsRead()">Marquer tout comme lu</button>
                <button class="btn btn-danger d-inline-block" onclick="deleteAllNotifications()">Supprimer tout</button>
            </div>
        </div>
        <div class="card-body">
            <div id="no-notifications" class="text-center" style="display: none;">
                <p class="text-muted">Aucune notification pour ce filtre.</p>
            </div>
            {% if notifications %}
                {% for notification in notifications %}
                    <div class="alert alert-{{ notification.type }} mb-3 notification" role="alert" id="notification-{{ notification.id }}"
                         data-type="{% if 'Stock critique' in notification.message %}danger-stock{% elif 'Stock faible' in notification.message %}warning-stock{% elif 'Retour proche' in notification.message %}warning-return{% else %}danger-overdue{% endif %}">
                        <i class="fas {% if 'Stock critique' in notification.message %}fa-exclamation-triangle{% elif 'Stock faible' in notification.message %}fa-exclamation-circle{% elif 'Retour proche' in notification.message %}fa-clock{% else %}fa-exclamation-triangle{% endif %} me-2" aria-hidden="true"></i>
                        {{ notification.message }}
                        <div class="float-end">
                            {% if not notification.is_read %}
                                <button class="btn btn-sm btn-secondary me-2" onclick="markAsRead({{ notification.id }})">Marquer comme lu</button>
                            {% endif %}
                            <button class="btn btn-sm btn-danger" onclick="deleteNotification({{ notification.id }})">Supprimer</button>
                        </div>
                    </div>
                {% endfor %}
            {% else %}
                <div id="no-notifications" class="text-center">
                    <p class="text-muted">Aucune notification pour le moment.</p>
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        function showToast(message, isError = false) {
            console.log(`Toast: ${message}, isError: ${isError}`);
            const toastElement = document.getElementById('notificationToast');
            const toastBody = toastElement.querySelector('.toast-body');
            toastBody.textContent = message;
            toastElement.classList.remove('bg-success', 'bg-danger');
            toastElement.classList.add(isError ? 'bg-danger' : 'bg-success');
            const toast = new bootstrap.Toast(toastElement, { delay: 3000 });
            toast.show();
        }

        function filterNotifications() {
            const filter = document.getElementById('typeFilter').value;
            const notifications = document.querySelectorAll('.notification');
            const noNotifications = document.getElementById('no-notifications');
            let visibleCount = 0;

            notifications.forEach(notification => {
                if (filter === 'all' || notification.dataset.type === filter) {
                    notification.style.display = 'block';
                    visibleCount++;
                } else {
                    notification.style.display = 'none';
                }
            });

            noNotifications.style.display = visibleCount === 0 ? 'block' : 'none';
        }

        function markAsRead(notificationId) {
            console.log(`Marquer comme lu: ID ${notificationId}`);
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            if (!csrfToken) {
                showToast('Erreur : Jeton CSRF manquant.', true);
                return;
            }

            fetch(`/notifications/mark-as-read/${notificationId}/`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => {
                console.log(`Réponse markAsRead: ${response.status}`);
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(`Erreur HTTP ${response.status}: ${text || response.statusText}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log(`Données markAsRead: ${JSON.stringify(data)}`);
                if (data.status === 'success') {
                    const notificationElement = document.getElementById(`notification-${notificationId}`);
                    const button = notificationElement.querySelector('.btn-secondary');
                    if (button) {
                        button.remove();
                    }
                    updateNotificationBadges();
                    showToast('Notification marquée comme lue.');
                    filterNotifications(); // Réappliquer le filtre
                } else {
                    showToast('Erreur : ' + data.message, true);
                }
            })
            .catch(error => {
                console.log(`Erreur markAsRead: ${error}`);
                showToast('Erreur : ' + error.message, true);
            });
        }

        function markAllAsRead() {
            console.log('Marquer tout comme lu');
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            if (!csrfToken) {
                showToast('Erreur : Jeton CSRF manquant.', true);
                return;
            }

            fetch("{% url 'mark_all_notifications_as_read' %}", {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => {
                console.log(`Réponse markAllAsRead: ${response.status}`);
                if (!response.ok) {
                    throw new Error(`Erreur HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(`Données markAllAsRead: ${JSON.stringify(data)}`);
                if (data.status === 'success') {
                    document.querySelectorAll('.notification').forEach(notification => {
                        const button = notification.querySelector('.btn-secondary');
                        if (button) {
                            button.remove();
                        }
                    });
                    updateNotificationBadges();
                    showToast(`Marqué ${data.count} notification(s) comme lue(s).`);
                    filterNotifications(); // Réappliquer le filtre
                } else {
                    showToast('Erreur : ' + data.message, true);
                }
            })
            .catch(error => {
                console.log(`Erreur markAllAsRead: ${error}`);
                showToast('Erreur : ' + error.message, true);
            });
        }

        function deleteNotification(notificationId) {
            console.log(`Supprimer notification: ID ${notificationId}`);
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            if (!csrfToken) {
                showToast('Erreur : Jeton CSRF manquant.', true);
                return;
            }

            fetch(`/notifications/delete/${notificationId}/`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => {
                console.log(`Réponse deleteNotification: ${response.status}`);
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(`Erreur HTTP ${response.status}: ${text || response.statusText}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log(`Données deleteNotification: ${JSON.stringify(data)}`);
                if (data.status === 'success') {
                    const notificationElement = document.getElementById(`notification-${notificationId}`);
                    if (notificationElement) {
                        notificationElement.remove();
                    }
                    updateNotificationBadges();
                    showToast('Notification supprimée.');
                    filterNotifications(); // Réappliquer le filtre
                    const remainingNotifications = document.querySelectorAll('.notification').length;
                    if (remainingNotifications === 0) {
                        document.getElementById('no-notifications').style.display = 'block';
                    }
                } else {
                    showToast('Erreur : ' + data.message, true);
                }
            })
            .catch(error => {
                console.log(`Erreur deleteNotification: ${error}`);
                showToast('Erreur : ' + error.message, true);
            });
        }

        function deleteAllNotifications() {
            console.log('Supprimer toutes les notifications');
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
            if (!csrfToken) {
                showToast('Erreur : Jeton CSRF manquant.', true);
                return;
            }

            fetch("{% url 'delete_all_notifications' %}", {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => {
                console.log(`Réponse deleteAllNotifications: ${response.status}`);
                if (!response.ok) {
                    throw new Error(`Erreur HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log(`Données deleteAllNotifications: ${JSON.stringify(data)}`);
                if (data.status === 'success') {
                    document.querySelectorAll('.notification').forEach(notification => {
                        notification.remove();
                    });
                    document.getElementById('no-notifications').style.display = 'block';
                    updateNotificationBadges();
                    showToast(`Supprimé ${data.count} notification(s).`);
                } else {
                    showToast('Erreur : ' + data.message, true);
                }
            })
            .catch(error => {
                console.log(`Erreur deleteAllNotifications: ${error}`);
                showToast('Erreur : ' + error.message, true);
            });
        }

        function updateNotificationBadges() {
            fetch("{% url 'notification_count_api' %}", {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                const badge = document.querySelector('.notification-badge');
                if (badge) {
                    badge.textContent = data.total;
                    badge.style.display = data.total > 0 ? 'inline' : 'none';
                }
            });
        }
    </script>
{% endblock %}
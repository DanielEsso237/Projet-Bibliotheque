{% extends 'books/base.html' %}
{% load static %}

{% block title %}Notifications{% endblock %}

{% block content %}
    <div class="card">
        <div class="card-header">
            <h3>Notifications</h3>
        </div>
        <div class="card-body">
            {% if notifications %}
                {% for notification in notifications %}
                    <div class="alert alert-{{ notification.type }} mb-3" role="alert" id="notification-{{ notification.id }}">
                        <i class="fas fa-exclamation-triangle me-2" aria-hidden="true"></i>
                        {{ notification.message }}
                        {% if not notification.is_read %}
                            <button class="btn btn-sm btn-secondary float-end" onclick="markAsRead({{ notification.id }})">Marquer comme lu</button>
                        {% endif %}
                    </div>
                {% endfor %}
            {% else %}
                <p class="text-center">Aucune notification pour le moment.</p>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        function markAsRead(notificationId) {
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            if (!csrfToken) {
                console.error('CSRF token non trouvé. Assurez-vous que la balise meta est présente dans base.html.');
                return;
            }

            fetch(`/notifications/mark-as-read/${notificationId}/`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Erreur réseau ou réponse invalide');
                }
                return response.json();
            })
            .then(data => {
                console.log('Réponse:', data);
                if (data.status === 'success') {
                    const notificationElement = document.getElementById(`notification-${notificationId}`);
                    const button = notificationElement.querySelector('button');
                    if (button) {
                        button.remove();
                    }
                    updateNotificationBadges(); // Rafraîchir les badges immédiatement
                } else {
                    console.error('Échec:', data.message);
                }
            })
            .catch(error => {
                console.error('Erreur lors de la mise à jour:', error);
            });
        }
    </script>
{% endblock %}
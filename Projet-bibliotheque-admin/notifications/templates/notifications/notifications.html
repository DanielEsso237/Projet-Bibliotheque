{% extends 'books/base.html' %}
{% load static %}

{% block title %}Notifications{% endblock %}

{% block content %}
    <div class="card">
        <div class="card-header">
            <h3>Notifications</h3>
        </div>
        <div class="card-body">
            {% if notifications %}
                {% for notification in notifications %}
                    <div class="alert alert-{{ notification.type }} mb-3" role="alert" id="notification-{{ notification.id }}">
                        <i class="fas fa-exclamation-triangle me-2" aria-hidden="true"></i>
                        {{ notification.message }}
                        {% if not notification.is_read %}
                            <button class="btn btn-sm btn-secondary float-end" onclick="markAsRead({{ notification.id }})">Marquer comme lu</button>
                        {% endif %}
                    </div>
                {% endfor %}
            {% else %}
                <p class="text-center">Aucune notification pour le moment.</p>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block extra_js %}
    <script>
        function markAsRead(notificationId) {
            const csrfTokenElement = document.querySelector('meta[name="csrf-token"]');
            if (!csrfTokenElement) {
                console.error('Balise meta CSRF non trouvée dans base.html');
                alert('Erreur : Jeton CSRF manquant. Veuillez recharger la page.');
                return;
            }
            const csrfToken = csrfTokenElement.getAttribute('content');
            if (!csrfToken || csrfToken.length !== 64) {
                console.error('Jeton CSRF invalide ou de longueur incorrecte:', csrfToken, 'Longueur:', csrfToken?.length);
                alert('Erreur : Jeton CSRF invalide. Veuillez recharger la page.');
                return;
            }

            console.log(`Envoi de la requête POST pour la notification ${notificationId} avec CSRF: ${csrfToken}`);
            fetch(`/notifications/mark-as-read/${notificationId}/`, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => {
                console.log('Statut HTTP:', response.status, response.statusText);
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(`Erreur HTTP ${response.status}: ${text || response.statusText}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Réponse serveur:', data);
                if (data.status === 'success') {
                    const notificationElement = document.getElementById(`notification-${notificationId}`);
                    const button = notificationElement.querySelector('button');
                    if (button) {
                        button.remove();
                    }
                    updateNotificationBadges();
                    alert('Notification marquée comme lue.');
                } else {
                    console.error('Échec:', data.message);
                    alert('Erreur : ' + data.message);
                }
            })
            .catch(error => {
                console.error('Erreur lors de la mise à jour:', error);
                alert('Une erreur est survenue lors du marquage de la notification comme lue: ' + error.message);
            });
        }
    </script>
{% endblock %}
{% extends "readers/base.html" %}
{% load static %}
{% block title %}{{ book.title }}{% endblock %}
{% block content %}
    <div class="container my-4">
        <div class="row">
            <div class="col-md-4">
                {% if book.cover_image %}
                    <img src="{{ book.cover_image.url }}" class="img-fluid" alt="{{ book.title }}">
                {% else %}
                    <img src="{% static 'images/default_book.jpg' %}" class="img-fluid" alt="Default cover">
                {% endif %}
            </div>
            <div class="col-md-8">
                <h2>{{ book.title }}</h2>
                <p><strong>Auteur:</strong> {{ book.author }}</p>
                <p><strong>Catégorie:</strong> {{ book.category }}</p>
                <p><strong>ISBN:</strong> {{ book.isbn }}</p>
                <p><strong>Date de publication:</strong> {{ book.publication_date }}</p>
                <p><strong>Disponible:</strong> {% if book.is_available %}Oui{% else %}Non{% endif %}</p>
                <p><strong>Résumé:</strong> {{ book.summary|default:"Aucun résumé disponible." }}</p>
                {% if user.is_authenticated %}
                    <button class="btn btn-link favorite-btn" data-book-id="{{ book.id }}" title="Ajouter aux favoris">
                        <i class="fas fa-star {% if book in user.favorites.all %}text-warning{% else %}text-muted{% endif %}"></i>
                    </button>
                {% endif %}
            </div>
        </div>
    </div>
    {% if user.is_authenticated %}
        <script src="{% static 'js/jquery.min.js' %}"></script>
        <script>
            $(document).ready(function() {
                $('.favorite-btn').click(function() {
                    const bookId = $(this).data('book-id');
                    const icon = $(this).find('i');
                    $.ajax({
                        url: '{% url 'books:toggle_favorite' %}',
                        method: 'POST',
                        data: {
                            book_id: bookId,
                            csrfmiddlewaretoken: '{{ csrf_token }}'
                        },
                        success: function(response) {
                            if (response.added) {
                                icon.removeClass('text-muted').addClass('text-warning');
                            } else {
                                icon.removeClass('text-warning').addClass('text-muted');
                            }
                        },
                        error: function() {
                            alert('Erreur lors de la mise à jour des favoris.');
                        }
                    });
                });
            });
        </script>
    {% endif %}
{% endblock %}
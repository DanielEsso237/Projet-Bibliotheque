{% extends "readers/base.html" %}
{% load static %}
{% block title %}Recherche de livres{% endblock %}
{% block content %}
    <div class="container my-4">
        <h2 class="text-center mb-4">Recherche de livres</h2>
        <form method="get" class="mb-4">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <input type="text" name="q" class="form-control" placeholder="Titre ou auteur" value="{{ query }}">
                </div>
                <div class="col-md-3 mb-3">
                    <select name="category" class="form-select">
                        <option value="">Toutes les catégories</option>
                        {% for category in categories %}
                            <option value="{{ category }}" {% if category == request.GET.category %}selected{% endif %}>{{ category }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="form-check">
                        <input type="checkbox" name="available" id="available" class="form-check-input" {% if request.GET.available %}checked{% endif %}>
                        <label for="available" class="form-check-label">Disponible uniquement</label>
                    </div>
                </div>
            </div>
            <button type="submit" class="btn btn-primary">Rechercher</button>
        </form>
        <div class="row">
            {% for book in books %}
                <div class="col-md-4 mb-4">
                    <div class="card h-100">
                        {% if book.cover_image %}
                            <img src="{{ book.cover_image.url }}" class="card-img-top" alt="{{ book.title }}">
                        {% else %}
                            <img src="{% static 'images/default_book.jpg' %}" class="card-img-top" alt="Default cover">
                        {% endif %}
                        <div class="card-body">
                            <h5 class="card-title">{{ book.title }}</h5>
                            <p class="card-text">Auteur: {{ book.author }}</p>
                            <p class="card-text">Catégorie: {{ book.category }}</p>
                            <p class="card-text">Disponible: {% if book.is_available %}Oui{% else %}Non{% endif %}</p>
                            <a href="{% url 'books:book_detail' book.pk %}" class="btn btn-primary">Voir détails</a>
                            {% if user.is_authenticated %}
                                <button class="btn btn-link favorite-btn" data-book-id="{{ book.id }}" title="Ajouter aux favoris">
                                    <i class="fas fa-star {% if book in user.favorites.all %}text-warning{% else %}text-muted{% endif %}"></i>
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% empty %}
                <p class="text-center">Aucun livre trouvé.</p>
            {% endfor %}
        </div>
    </div>
    {% if user.is_authenticated %}
        <script src="{% static 'js/jquery.min.js' %}"></script>
        <script>
            $(document).ready(function() {
                $('.favorite-btn').click(function() {
                    const bookId = $(this).data('book-id');
                    const icon = $(this).find('i');
                    $.ajax({
                        url: '{% url 'books:toggle_favorite' %}',
                        method: 'POST',
                        data: {
                            book_id: bookId,
                            csrfmiddlewaretoken: '{{ csrf_token }}'
                        },
                        success: function(response) {
                            if (response.added) {
                                icon.removeClass('text-muted').addClass('text-warning');
                            } else {
                                icon.removeClass('text-warning').addClass('text-muted');
                            }
                        },
                        error: function() {
                            alert('Erreur lors de la mise à jour des favoris.');
                        }
                    });
                });
            });
        </script>
    {% endif %}
{% endblock %}